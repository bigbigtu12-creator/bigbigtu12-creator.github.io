name: Daily Poem to Notion

on:
  schedule:
    # 北京时间 06:00（UTC+8）→ UTC 22:00 前一天
    - cron: "0 22 * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run daily poem script
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          cat > index.mjs << 'EOF'
          // 使用 Node.js 20 原生 fetch，无需安装 node-fetch

          const NOTION_TOKEN = process.env.NOTION_TOKEN;
          const DB = process.env.NOTION_DATABASE_ID;

          function todayInShanghaiISO() {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const sh = new Date(utc + 8 * 3600000);
            return sh.toISOString().slice(0,10);
          }

          async function withRetry(fn, times = 3, delayMs = 1000) {
            let lastErr;
            for (let i = 0; i < times; i++) {
              try { return await fn(); } catch (e) {
                lastErr = e;
                if (i < times - 1) await new Promise(r => setTimeout(r, delayMs));
              }
            }
            throw lastErr;
          }

          async function fetchPoem() {
            const url = "https://v2.jinrishici.com/one.json";
            const r = await fetch(url, {
              headers: { "User-Agent": "daily-poem-notion-action" }
            });
            if (!r.ok) throw new Error("Jinrishici HTTP " + r.status);
            const j = await r.json();
            const d = j?.data || {};
            const origin = d?.origin || {};
            const title = origin?.title || "未题诗";
            const author = origin?.author || "";
            const dynasty = origin?.dynasty || "";
            let lines = [];
            if (Array.isArray(origin?.content)) lines = origin.content;
            else if (Array.isArray(origin?.paragraphs)) lines = origin.paragraphs;
            else if (typeof d?.content === "string") lines = [d.content.trim()];
            const fullText = lines.join("\n");
            return { title, author, dynasty, fullText };
          }

          async function notionQueryByDate(dateISO) {
            const r = await fetch(`https://api.notion.com/v1/databases/${DB}/query`, {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${NOTION_TOKEN}`,
                "Notion-Version": "2022-06-28",
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                filter: { property: "日期", date: { equals: dateISO } }
              })
            });
            if (!r.ok) throw new Error("Notion query HTTP " + r.status + " " + await r.text());
            return r.json();
          }

          async function notionCreatePage({ title, author, dynasty, fullText, dateISO }) {
            const r = await fetch("https://api.notion.com/v1/pages", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${NOTION_TOKEN}`,
                "Notion-Version": "2022-06-28",
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                parent: { database_id: DB },
                properties: {
                  "诗题": { title: [{ text: { content: title } }] },
                  "作者": { rich_text: [{ text: { content: author } }] },
                  "朝代": { rich_text: [{ text: { content: dynasty } }] },
                  "全文": { rich_text: [{ text: { content: fullText } }] },
                  "日期": { date: { start: dateISO } }
                }
              })
            });
            if (!r.ok) throw new Error("Notion create HTTP " + r.status + " " + await r.text());
            return r.json();
          }

          async function main() {
            const dateISO = todayInShanghaiISO();
            const q = await notionQueryByDate(dateISO);
            if (Array.isArray(q?.results) && q.results.length) {
              console.log("Skip: already exists for", dateISO);
              return;
            }

            const poem = await withRetry(fetchPoem);
            if (!poem.fullText?.trim()) throw new Error("Empty poem");

            const res = await notionCreatePage({ ...poem, dateISO });
            console.log("✅ Created:", res?.id);
          }

          main().catch(e => {
            console.error("❌ Error:", e.message || e);
            process.exit(1);
          });
          EOF

          node index.mjs
