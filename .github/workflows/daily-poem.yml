name: Daily Poem to Notion

on:
  schedule:
    # 北京时间 06:00（UTC+8），对应 UTC 前一日 22:00
    - cron: "0 22 * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Run script
        env:
          NOTION_TOKEN: $ secrets.NOTION_TOKEN 
          NOTION_DATABASE_ID: $ secrets.NOTION_DATABASE_ID 
        run: |
          cat > index.mjs << 'EOF'
          import fetch from "node-fetch";

          const NOTION_TOKEN = process.env.NOTION_TOKEN;
          const DB = process.env.NOTION_DATABASE_ID;

          // 计算“今天”（按北京时间）
          function todayInShanghaiISO() {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const sh = new Date(utc + 8 * 3600000);
            return sh.toISOString().slice(0,10);
          }

          // 简单重试封装
          async function withRetry(fn, times = 3, delayMs = 800) {
            let lastErr;
            for (let i = 0; i < times; i++) {
              try { return await fn(); } catch (e) {
                lastErr = e;
                if (i < times - 1) await new Promise(r => setTimeout(r, delayMs));
              }
            }
            throw lastErr;
          }

          // 获取整首诗（优先 content/paragraphs）
          async function fetchPoem() {
            const url = "https://v2.jinrishici.com/one.json";
            const r = await fetch(url, {
              headers: { "User-Agent": "daily-poem-notion-action" }
            });
            if (!r.ok) throw new Error("Jinrishici HTTP " + r.status);
            const j = await r.json();
            const d = j?.data || {};
            const origin = d?.origin || {};
            const title = origin?.title || "未题诗";
            const author = origin?.author || "";
            const dynasty = origin?.dynasty || "";
            let lines = [];
            if (Array.isArray(origin?.content) && origin.content.length) {
              lines = origin.content;
            } else if (Array.isArray(origin?.paragraphs) && origin.paragraphs.length) {
              lines = origin.paragraphs;
            } else if (typeof d?.content === "string" && d.content.trim()) {
              lines = [d.content.trim()];
            }
            const fullText = lines.join("\n");
            return { title, author, dynasty, fullText };
          }

          async function notionQueryByDate(dateISO) {
            const r = await fetch(\`https://api.notion.com/v1/databases/\${DB}/query\`, {
              method: "POST",
              headers: {
                "Authorization": \`Bearer \${NOTION_TOKEN}\`,
                "Notion-Version": "2022-06-28",
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                filter: { property: "日期", date: { equals: dateISO } }
              })
            });
            if (!r.ok) throw new Error("Notion query HTTP " + r.status + " " + await r.text());
            return r.json();
          }

          async function notionCreatePage({ title, author, dynasty, fullText, dateISO }) {
            const r = await fetch("https://api.notion.com/v1/pages", {
              method: "POST",
              headers: {
                "Authorization": \`Bearer \${NOTION_TOKEN}\`,
                "Notion-Version": "2022-06-28",
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                parent: { database_id: DB },
                properties: {
                  "诗题": { title: [{ type: "text", text: { content: title } }] },
                  "作者": { rich_text: [{ type: "text", text: { content: author } }] },
                  "朝代": { rich_text: [{ type: "text", text: { content: dynasty } }] },
                  "全文": { rich_text: [{ type: "text", text: { content: fullText } }] },
                  "日期": { date: { start: dateISO } }
                }
              })
            });
            if (!r.ok) throw new Error("Notion create HTTP " + r.status + " " + await r.text());
            return r.json();
          }

          async function main() {
            const dateISO = todayInShanghaiISO();

            // 去重：当天已有记录则跳过
            const q = await notionQueryByDate(dateISO);
            if (Array.isArray(q?.results) && q.results.length) {
              console.log("Skip: already exists for", dateISO);
              return;
            }

            // 获取并写入
            const poem = await withRetry(fetchPoem, 3, 1000);
            if (!poem.fullText) {
              throw new Error("Empty fullText from API");
            }

            const res = await notionCreatePage({ ...poem, dateISO });
            console.log("Created:", res?.id || res);
          }

          main().catch(e => { console.error(e); process.exit(1); });
          EOF
          node index.mjs
